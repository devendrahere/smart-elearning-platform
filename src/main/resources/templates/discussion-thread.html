<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${thread.title}">Discussion Thread</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- External CSS file -->
    <link rel="stylesheet" th:href="@{/css/discussion-thread.css}">
</head>

<body>
<th:block th:replace="fragments/header :: header"></th:block>

<div class="container">
    <!-- Title Section -->
    <div class="thread-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="thread-title">üí¨ <span th:text="${thread.title}">Discussion Thread</span></h2>

            <button th:if="${isThreadOwner}"
                    class="btn btn-outline-danger btn-sm"
                    th:onclick="|deleteThread(${thread.threadId})|">
                üóë Delete Thread
            </button>
        </div>
    </div>

    <!-- Chat Section -->
    <div class="chat-wrapper">

        <div id="chatBox" class="chat-box">
            <div th:each="msg : ${messages}"
                 class="message"
                 th:classappend="${msg.userId == userId} ? ' msg-self' : ''"
                 th:attr="data-discussion-id=${msg.discussionId}">

                <div class="message-header">
                    <strong th:text="${msg.username}">User</strong>

                    <button th:if="${(msg.userId == userId) or isInstructor}"
                            class="btn-delete"
                            th:attr="data-discussion-id=${msg.discussionId}"
                            onclick="deleteMessage(this)">‚úñ</button>
                </div>

                <p class="mb-1" th:text="${msg.content}"></p>
                <small th:text="${#temporals.format(msg.createdAt, 'dd MMM yyyy HH:mm')}"></small>
            </div>
        </div>

        <!-- Input -->
        <div class="chat-input">
            <input id="messageInput" type="text" class="form-control" placeholder="Write a message...">
            <button id="sendBtn" class="btn-send">Send</button>
        </div>

        <!-- Back -->
        <div class="mt-4">
            <a th:href="@{'/discussion/course/' + ${thread.courseId}}" class="btn btn-outline-secondary btn-back">
                ‚Üê Back to Threads
            </a>
        </div>
    </div>
</div>

<th:block th:replace="fragments/footer :: footer"></th:block>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
        const threadId = /*[[${thread != null ? thread.threadId : 0}]]*/ 0;
        const userId = /*[[${userId != null ? userId : 'null'}]]*/ null;
        const username = /*[['' + (${username} ?: 'Anonymous')]]*/ 'Anonymous';
        const courseId = /*[[${thread != null ? thread.courseId : 0}]]*/ 0;
        const isInstructor = /*[[${isInstructor}]]*/ false;

        let stompClient = null;

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function () {
                stompClient.subscribe(`/topic/discussion/${threadId}`, function (message) {
                    appendMessage(JSON.parse(message.body));
                });
            });
        }

        function appendMessage(msg) {
            const chat = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = 'message';

            if (msg.userId && userId && Number(msg.userId) === Number(userId)) {
                div.classList.add('msg-self');
            }

            const allowDelete = (msg.userId && userId && Number(msg.userId) === Number(userId)) || isInstructor;

            div.innerHTML = `
                <div class="message-header">
                    <strong>${msg.username}</strong>
                    ${allowDelete ? `<button class="btn-delete" data-discussion-id="${msg.discussionId}" onclick="deleteMessage(this)">‚úñ</button>` : ''}
                </div>
                <p class="mb-1">${msg.content}</p>
                <small>${new Date(msg.createdAt).toLocaleString()}</small>
            `;

            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        document.getElementById('sendBtn').addEventListener('click', () => {
            const content = document.getElementById('messageInput').value.trim();
            if (!content) return;

            if (!userId) {
                alert('Please log in to participate.');
                window.location.href = '/login';
                return;
            }

            stompClient.send(`/app/discussion/${threadId}`, {}, JSON.stringify({
                content,
                userId: Number(userId),
                username,
                threadId: Number(threadId),
                courseId: Number(courseId)
            }));

            document.getElementById('messageInput').value = '';
        });

        async function deleteMessage(btn) {
            const id = btn.getAttribute('data-discussion-id');
            if (!confirm('Delete this message?')) return;

            const resp = await fetch(`/api/discussions/${id}`, { method: 'DELETE' });

            if (resp.status === 204) btn.closest('.message').remove();
        }

        async function deleteThread(tid) {
            if (!confirm('Delete this thread?')) return;

            const resp = await fetch(`/api/discussions/thread/${tid}`, { method: 'DELETE' });

            if (resp.status === 204)
                window.location.href = `/discussion/course/${courseId}`;
        }

        connect();
    /*]]>*/
</script>

</body>
</html>